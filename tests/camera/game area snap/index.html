<meta name="viewport" content="width=device-width"/>

<canvas id="canvas" style="border:1px solid;"></canvas>
<canvas id="renderCanvas" width="640" height="300" style="border:1px solid;"></canvas>
<button onclick="activeArea=0">Area 1</button>
<button onclick="activeArea=1">Area 2</button>
<button onclick="activeArea=2">Area 3</button>
<button onclick="activeArea=3">Area 4</button>

<script> L = console.log </script>
<script src="control.js"></script>
<script>

	let c = canvas.getContext('2d');
	let cr = renderCanvas.getContext('2d');
	let enemy = Enemy();
	let player = Player();
	let cam = Cam(player);
	let object = [player, enemy, cam];
	let viewport = {
    x: 0,
    y: 0,
    width: canvas.width,
    height: canvas.height,
  }
  let areas = [
    {
      x: 0,
      y: 0,
      width: canvas.width,
      height: canvas.height,
    },
    {
      x: canvas.width,
      y: 0,
      width: canvas.width,
      height: canvas.height,
    },
    {
      x: canvas.width,
      y: canvas.height,
      width: canvas.width,
      height: canvas.height,
    },
    {
      x: 0,
      y: canvas.height,
      width: canvas.width,
      height: canvas.height,
    },
  ];
  let activeArea = 0;
  Object.defineProperty(window, 'area', { get: () => areas[activeArea] })
	
	function update() {
	  cr.clearRect(0,0,cr.canvas.width,cr.canvas.height)
	  window.requestAnimationFrame(update);
	  drawObjects()
	  c.clearRect(0,0,canvas.width,canvas.height)
	  
	  viewport.x = cam.pos.x-viewport.width/2
	  viewport.y = cam.pos.y-viewport.height/2
	  snapCamToArea();
	  snapCamToWorldEdge();
	  c.drawImage(renderCanvas, viewport.x, viewport.y, viewport.width, viewport.height, 0, 0, viewport.width, viewport.height);
	}
	
	function snapCamToArea() {
	  if (viewport.x < area.x)
  	   viewport.x = area.x;
  	else if (viewport.x+viewport.width > area.width)
  	   viewport.x = (area.x+area.width) - viewport.width;
   	if (viewport.y < area.y)
  	   viewport.y = area.y;
    else if (viewport.y+viewport.height > area.height)
  	   viewport.y = (area.y+area.height) - viewport.height;
	}
	
	function snapCamToWorldEdge() {
	  if (viewport.x < 0)
  	   viewport.x = 0;
  	else if (viewport.x+viewport.width > renderCanvas.width)
  	   viewport.x = renderCanvas.width - viewport.width;
   	if (viewport.y < 0)
  	   viewport.y = 0;
    else if (viewport.y+viewport.height > renderCanvas.height)
  	   viewport.y = renderCanvas.height - viewport.height;
	}
	
	function drawObjects() {
	  for (let i=0; i<object.length; i++) {
	    object[i].update();
	    cr.fillRect(object[i].pos.x, object[i].pos.y, object[i].pos.w, object[i].pos.h);
	  }
	}
	
	function Cam(target) {
    let pos = {
      x: 0,
      y: 0,
      w:5,
      h:5,
    }
    
    function update() {
      // if (viewport.x > pos.x)
      // pos.x += (Math.max(target.pos.x, viewport.x) - pos.x) * 0.05
      // else
      pos.x += (target.pos.x - pos.x) * 0.05
       
      pos.y += (target.pos.y - pos.y) * 0.05
    }
      
    let self = {
      pos,
      update,
    };
    
    return self;
	}
	
	function Enemy() {
	  let pos = {
  	  x: 10, 
  	  y: 20,
  	  w: 10,
  	  h: 10,
  	};
  	
  	function update() {
  	}
  	
	  let self = {
	    pos,
	    update,
	  }
	  
	  return self;
	}
	
	function Player() {
  	let pos = {
  	  x: 150, 
  	  y: 120,
  	  w: 10,
  	  h: 10,
  	};
  	let vspeed = 2;
  	let hspeed = 2;
  	
	  let bodyState = {
      state: null,
      change: function(stateName) {
        this.state = bodyState[stateName];
      },
      idle: {
        update: function() {
          if (controls.left || controls.right || controls.up || controls.down)
            bodyState.change('move');
        }
      },
      move: {
        update: function() {
          move = false;
          pos.l = false;
          pos.r = false;
          pos.b = false;
          pos.t = false;
          
          if (controls.left) {
            oldX = pos.x
            pos.x -= vspeed;
            pos.l = true;
            move = true;
          } else if (controls.right) {
            oldX = pos.x
            pos.x += vspeed;
            pos.r = true;
            move = true;
          }
          
          if (controls.up) {
            oldY = pos.y
            pos.y -= hspeed;
            move = true;
            pos.t = true
          } else if (controls.down) {
            oldY = pos.y
            pos.y += hspeed;
            move = true;
            pos.b = true
          }
          
          if (!move) {
            bodyState.change('idle');
          }
        }
      },
    };
    bodyState.state = bodyState.idle;
	  
	  function updateMovement() {
      bodyState.state.update();
    }
	  
	  function update() {
      updateMovement();
    }
	  
	  let self = {
	    pos,
	    update,
	  }
	  
	  return self;
	}
	
	attachListener();
	update();

</script>